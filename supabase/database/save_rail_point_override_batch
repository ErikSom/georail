CREATE OR REPLACE FUNCTION save_rail_point_overrides_batch(
  p_segment_ids bigint[],     -- An array of all segment IDs
  p_indices integer[],         -- An array of all point indices
  p_new_zs double precision[],  -- An array of all new heights
  p_new_ms double precision[],   -- An array of all new lateral offsets
  p_keynodes boolean[]       -- Added keynodes array
)
RETURNS void
LANGUAGE sql
SECURITY DEFINER
AS $$
  INSERT INTO public.rail_point_overrides (
    segment_id, point_index, height, lateral_offset, keynode -- Added 'keynode'
  )
  SELECT
    segment_id,
    point_index,
    height,
    lateral_offset,
    keynode -- Added 'keynode'
  FROM
    -- UNNEST "zips" the parallel arrays into a set of rows
    UNNEST(p_segment_ids, p_indices, p_new_zs, p_new_ms, p_keynodes) -- Added p_keynodes
    AS t(segment_id, point_index, height, lateral_offset, keynode) -- Added 'keynode'
  ON CONFLICT (segment_id, point_index) -- If a row already exists
  DO UPDATE SET
    height = EXCLUDED.height,
    lateral_offset = EXCLUDED.lateral_offset,
    keynode = EXCLUDED.keynode; -- Added 'keynode'
$$;